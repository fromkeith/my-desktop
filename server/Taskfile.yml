# https://taskfile.dev

version: "3"

tasks:
    build-server:
        env:
            CGO_ENABLED: 1
        cmds:
            - go build -tags=jsoniter .
    build-injestor:
        cmds:
            - go build ./services/email-injestor
    build-gemini:
        cmds:
            - go build ./services/gemini
    build-tagsAndCats:
        cmds:
            - go build ./services/tagsAndCats
    build-messageToThread:
        cmds:
            - go build ./services/messageToThread

    run-server:
        deps:
            - build-server
        cmds:
            - ./my-desktop-server
    run-injestor:
        deps:
            - build-injestor
        cmds:
            - ./email-injestor
    run-gemini:
        deps:
            - build-gemini
        cmds:
            - ./gemini
    run-tagsAndCats:
        deps:
            - build-tagsAndCats
        cmds:
            - ./tagsAndCats
    run-messageToThread:
        deps:
            - build-messageToThread
        cmds:
            - ./messageToThread

    migrate-postgres:
        cmds:
            - dbmate -d ./migrations -u postgres://postgres:postgres@localhost:5432/desktop?sslmode=disable up
    migrate-mongo:
        cmds:
            - cd migrations/mongo && migrate-mongo up
    # eg: task migrate-mongo-create -- cliargshere
    migrate-mongo-create:
        cmds:
            - cd migrations/mongo && migrate-mongo create {{.CLI_ARGS}}
    migrate-mongo-down:
        cmds:
            - cd migrations/mongo && migrate-mongo down

    up:
        cmds:
            - docker-compose up -d
    down:
        cmds:
            - docker-compose down

    swag:
        cmds:
            - swag init --parseVendor --parseDependency

    run-all:
        deps:
            - run-server
            - run-injestor
            - run-gemini
            - run-tagsAndCats
            - run-messageToThread
